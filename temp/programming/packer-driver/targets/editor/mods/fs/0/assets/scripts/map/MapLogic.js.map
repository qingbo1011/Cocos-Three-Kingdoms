{"version":3,"sources":["file:///D:/git/github/mszlu/games/slg/ms-sg/assets/scripts/map/MapLogic.ts"],"names":["_decorator","Component","Camera","Node","Vec2","UITransform","Vec3","view","MapCommand","MapUtil","EventMgr","ccclass","property","MapLogic","onLoad","console","log","_cmd","getInstance","_mapCamera","node","parent","getChildByName","getComponent","_orthoHeight","orthoHeight","on","openCityAbout","closeCityAbout","onDestroy","targetOff","setTiledMap","tiledMap","_tiledMap","enableCulling","updateCulling","uit","_maxMapX","width","getVisibleSize","_maxMapY","height","EventType","MOUSE_WHEEL","onMouseWheel","TOUCH_START","onTouchBegan","TOUCH_MOVE","onTouchMove","TOUCH_END","onTouchEnd","TOUCH_CANCEL","onTouchCancel","data","_maxZoomRatio","_minZoomRatio","event","scrollY","getScrollY","changeRatio","Number","_changeZoomRadix","toFixed","newZoomRatio","Math","min","max","_isTouch","delta","getDelta","x","y","_isMove","pixelPoint","position","setPosition","z","setCenterMapCellPoint","mapPixelToCellPoint","touchLocation","touch","getUILocation","touchLocation1","viewPointToWorldPoint","mapPoint","worldPixelToMapCellPoint","clickCenterPoint","mapCellToPixelPoint","emit","point","canvasNode","cuit","cameraWorldX","anchorX","cameraWorldY","anchorY","worldToMapPixelPoint","pixelX","pixelY","scrollToMapPoint","positionX","positionY","pos","clone","proxy","setCurCenterPoint","TRANSFORM_CHANGED","scheduleOnce"],"mappings":"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","sourcesContent":["import { _decorator, Component, TiledMap, Camera, Node, Vec2, Event, game, UITransform, EventMouse, EventTouch, Vec3, view } from 'cc';\nconst { ccclass, property } = _decorator;\n\nimport MapCommand from \"./MapCommand\";\nimport MapUtil from \"./MapUtil\";\nimport { EventMgr } from '../utils/EventMgr';\n\n@ccclass('MapLogic')\nexport default class MapLogic extends Component {\n    protected _cmd: MapCommand;\n    protected _tiledMap: TiledMap = null;\n    protected _mapCamera: Camera = null;\n    protected _isTouch: boolean = false;\n    protected _isMove: boolean = false;\n    //地图相机缩放倍率边界\n    protected _minZoomRatio: number = 1;\n    protected _maxZoomRatio: number = 0.8;\n    protected _changeZoomRadix: number = 200;\n    protected _orthoHeight:number = 360;\n\n    //地图相机移动边界\n    protected _maxMapX: number = 1;\n    protected _maxMapY: number = 1;\n\n    protected _touchAniNode: Node = null;\n    protected _centerPoint: Vec2 = null;\n\n    protected onLoad(): void {\n        console.log(\"MapLogic onLoad\");\n        this._cmd = MapCommand.getInstance();\n        this._mapCamera = this.node.parent.getChildByName(\"Map Camera\").getComponent(Camera);\n        console.log(\"_mapCamera:\", this._mapCamera);\n        this._orthoHeight = this._mapCamera.orthoHeight;\n\n        EventMgr.on(\"open_city_about\", this.openCityAbout, this);\n        EventMgr.on(\"close_city_about\", this.closeCityAbout, this);\n\n    }\n\n    protected onDestroy(): void {\n        EventMgr.targetOff(this);\n\n        this._cmd = null;\n    }\n\n    public setTiledMap(tiledMap: TiledMap): void {\n        this._tiledMap = tiledMap;\n        this._tiledMap.enableCulling = true;\n\n        this.updateCulling();\n        \n        var uit = this._tiledMap.node.getComponent(UITransform);\n        this._maxMapX = (uit.width - view.getVisibleSize().width) * 0.5;\n        this._maxMapY = (uit.height - view.getVisibleSize().height) * 0.5;\n        this._tiledMap.node.on(Node.EventType.MOUSE_WHEEL, this.onMouseWheel, this);\n        this._tiledMap.node.on(Node.EventType.TOUCH_START, this.onTouchBegan, this);\n        this._tiledMap.node.on(Node.EventType.TOUCH_MOVE, this.onTouchMove, this);\n        this._tiledMap.node.on(Node.EventType.TOUCH_END, this.onTouchEnd, this);\n        this._tiledMap.node.on(Node.EventType.TOUCH_CANCEL, this.onTouchCancel, this);\n    }\n\n    protected openCityAbout(data: any): void {\n        this._mapCamera.orthoHeight = this._orthoHeight * this._maxZoomRatio;\n    }\n\n    protected closeCityAbout(): void {\n        this._mapCamera.orthoHeight = this._orthoHeight * this._minZoomRatio;\n    }\n\n    protected onMouseWheel(event: EventMouse): void {\n        console.log(\"onMouseWheel\");\n\n        let scrollY: number = event.getScrollY();\n        let changeRatio: number = Number((scrollY / this._changeZoomRadix).toFixed(1));\n        let newZoomRatio: number = Math.min(this._minZoomRatio, Math.max(this._maxZoomRatio, this._mapCamera.orthoHeight/this._orthoHeight + changeRatio));\n\n        console.log(\"onMouseWheel:\", newZoomRatio);\n        this._mapCamera.orthoHeight = this._orthoHeight * newZoomRatio;\n    }\n\n    protected onTouchMove(event: EventTouch): void {\n        if (this._isTouch) {\n            let delta: Vec2 = event.getDelta();\n            if (delta.x != 0 || delta.y != 0) {\n                this._isMove = true;\n                let pixelPoint: Vec2 = new Vec2(0, 0);\n                pixelPoint.x = this._mapCamera.node.position.x - delta.x;\n                pixelPoint.y = this._mapCamera.node.position.y - delta.y;\n                pixelPoint.x = Math.min(this._maxMapX, Math.max(-this._maxMapX, pixelPoint.x));\n                pixelPoint.y = Math.min(this._maxMapY, Math.max(-this._maxMapY, pixelPoint.y));\n                this._mapCamera.node.setPosition(new Vec3(pixelPoint.x, pixelPoint.y, this._mapCamera.node.position.z));\n                this.setCenterMapCellPoint(MapUtil.mapPixelToCellPoint(pixelPoint), pixelPoint);\n                this.updateCulling();\n            }\n        }\n    }\n\n    protected onTouchBegan(event: EventTouch): void {\n        this._isTouch = true;\n        this._isMove = false;\n    }\n\n    protected onTouchEnd(event: EventTouch): void {\n        this._isTouch = false;\n        if (this._isMove == false) {\n            let touchLocation: Vec2 = event.touch.getUILocation();\n            let touchLocation1 = this.viewPointToWorldPoint(touchLocation);\n            let mapPoint: Vec2 = MapUtil.worldPixelToMapCellPoint(touchLocation1);\n            let clickCenterPoint: Vec2 = MapUtil.mapCellToPixelPoint(mapPoint);\n            //派发事件\n            // console.log(\"onTouchEnd:\", touchLocation1, clickCenterPoint);\n\n            EventMgr.emit(\"touch_map\", mapPoint, clickCenterPoint);\n        } else {\n            EventMgr.emit(\"move_map\");\n        }\n        this._isMove = false;\n    }\n\n    protected onTouchCancel(event: EventTouch): void {\n        this._isTouch = false;\n        this._isMove = false;\n    }\n\n    //界面坐标转世界坐标\n    protected viewPointToWorldPoint(point: Vec2): Vec2 {\n        // console.log(\"viewPointToWorldPoint in\", point.x, point.y);\n\n        let canvasNode: Node = this.node.parent;\n        let cuit = canvasNode.getComponent(UITransform);\n        let uit = this._tiledMap.node.getComponent(UITransform);\n\n\n        let cameraWorldX: number = uit.width * uit.anchorX - view.getVisibleSize().width * cuit.anchorX + this._mapCamera.node.position.x;\n        let cameraWorldY: number = uit.height * uit.anchorY - view.getVisibleSize().height * cuit.anchorY + this._mapCamera.node.position.y;\n\n        return new Vec2(point.x + cameraWorldX, point.y + cameraWorldY);\n    }\n\n\n\n    //世界坐标转化为相对地图的像素坐标\n    protected worldToMapPixelPoint(point: Vec2): Vec2 {\n        var uit = this._tiledMap.node.getComponent(UITransform);\n        let pixelX: number = point.x - uit.width * uit.anchorX;\n        let pixelY: number = point.y - uit.height * uit.anchorY;\n        return new Vec2(pixelX, pixelY);\n    }\n\n    public scrollToMapPoint(point: Vec2): void {\n        let pixelPoint: Vec2 = MapUtil.mapCellToPixelPoint(point);\n        // console.log(\"scrollToMapPoint\", pixelPoint.x, pixelPoint.y);\n        let positionX: number = Math.min(this._maxMapX, Math.max(-this._maxMapX, pixelPoint.x));\n        let positionY: number = Math.min(this._maxMapY, Math.max(-this._maxMapY, pixelPoint.y));\n        let pos = this._mapCamera.node.position.clone();\n        pos.x = positionX;\n        pos.y = positionY;\n        this._mapCamera.node.position = pos;\n    \n        this.setCenterMapCellPoint(point, pixelPoint);\n\n        this.updateCulling();\n    }\n\n    protected setCenterMapCellPoint(point: Vec2, pixelPoint: Vec2): void {\n        this._cmd.proxy.setCurCenterPoint(point, pixelPoint);\n    }\n\n    private updateCulling() {\n        if(this._tiledMap){\n            // let layers = this._tiledMap.getLayers();\n            // for (let index = 0; index < layers.length; index++) {\n            //     const l = layers[index];\n            //     l.updateCulling();\n            // }\n\n            // this.scheduleOnce(()=>{\n            //     for (let index = 0; index < layers.length; index++) {\n            //         const l = layers[index];\n            //         l.updateCulling();\n            //     }\n            // })\n\n            this._tiledMap.node.emit(Node.EventType.TRANSFORM_CHANGED);\n            this.scheduleOnce(()=>{\n                this._tiledMap.node.emit(Node.EventType.TRANSFORM_CHANGED);\n            })\n    \n        }\n\n     }\n}\n"]}