{"version":3,"sources":["file:///D:/git/github/mszlu/games/slg/ms-sg/assets/scripts/core/LoaderManager.ts"],"names":["LoadData","LoadCompleteData","LoaderManager","Asset","resources","EventMgr","LoadDataType","constructor","path","loadType","FILE","fileType","getInstance","_instance","destory","onDestory","_loadDataList","length","loadNext","_curIndex","onComplete","data","DIR","loadDir","finish","total","onProgress","error","assets","_completePaths","push","_completeAssets","load","asset","percent","subPercent","totalPercent","Number","toFixed","_target","_progressCallback","call","emit","_completeCallback","clearData","_isLoading","startLoad","loadProgress","loadComplete","target","startLoadList","dataList"],"mappings":"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","sourcesContent":["import { _decorator, Asset, resources } from 'cc';\nimport { EventMgr } from '../utils/EventMgr';\n\nexport enum LoadDataType {\n    DIR,\n    FILE\n}\n\nexport class LoadData {\n    path: string = \"\";\n    loadType: LoadDataType = LoadDataType.FILE;\n    fileType: typeof Asset = Asset; \n\n    constructor(path: string = \"\", loadType: LoadDataType = LoadDataType.FILE, fileType: typeof Asset = Asset) {\n        this.path = path;\n        this.loadType = loadType;\n        this.fileType = fileType;\n    }\n}\n\nexport class LoadCompleteData {\n    path: string = \"\";\n    data: any;\n}\n\nexport default class LoaderManager {\n    //单例\n    protected static _instance: LoaderManager;\n    public static getInstance(): LoaderManager {\n        if (this._instance == null) {\n            this._instance = new LoaderManager();\n        }\n        return this._instance;\n    }\n\n    public static destory(): boolean {\n        if (this._instance) {\n            this._instance.onDestory();\n            this._instance = null;\n            return true;\n        }\n        return false;\n    }\n\n    protected _isLoading: boolean = false;\n    protected _curIndex: number = -1;\n    protected _loadDataList: LoadData[] = [];\n    protected _completePaths: string[] = [];\n    protected _completeAssets: any[] = [];\n    protected _progressCallback: Function = null;\n    protected _completeCallback: Function = null;\n    protected _target: any = null;\n\n    constructor() {\n\n    }\n\n    public onDestory(): void {\n        this._loadDataList.length = 0;\n    }\n\n    protected loadNext(): void {\n        if (this._curIndex >= this._loadDataList.length) {\n            this.onComplete();\n            return;\n        }\n        let data: LoadData = this._loadDataList[this._curIndex];\n        if (data.loadType == LoadDataType.DIR) {\n            //加载目录\n            resources.loadDir(data.path, data.fileType, \n                (finish: number, total: number) => {\n                    this.onProgress(finish, total);\n                },\n                (error: Error, assets: any[]) => {\n                    if (error == null) {\n                        this._completePaths.push(data.path);\n                        this._completeAssets.push(assets);\n                        this._curIndex++;\n                        this.loadNext();\n                    } else {\n                        this.onComplete(error);\n                    }\n                });\n        } else {\n            //加载文件\n            resources.load(data.path, data.fileType, \n                (finish: number, total: number) => {\n                    this.onProgress(finish, total);\n                },\n                (error: Error, asset: any) => {\n                    if (error == null) {\n                        this._completePaths.push(data.path);\n                        this._completeAssets.push(asset);\n                        this._curIndex++;\n                        this.loadNext();\n                    } else {\n                        this.onComplete(error);\n                    }\n                });\n        }\n    }\n\n    protected onProgress(finish: number, total: number): void {\n        let percent: number = 1 / this._loadDataList.length;\n        let subPercent:number = (finish / total) * percent;\n        let totalPercent:number = Number((subPercent + percent * this._curIndex).toFixed(2));\n        if (this._target && this._progressCallback) {\n            this._progressCallback.call(this._target, totalPercent);\n        }\n        EventMgr.emit(\"load_progress\", totalPercent);\n    }\n\n    protected onComplete(error: Error = null): void {\n        if (this._target && this._completeCallback) {\n            this._completeCallback.call(this._target, error, this._completePaths, this._completeAssets);\n        }\n        EventMgr.emit(\"load_complete\");\n        this.clearData();\n    }\n\n    protected clearData(): void {\n        this._isLoading = false;\n        this._loadDataList.length = 0;\n        this._progressCallback = null;\n        this._completeCallback = null;\n        this._target = null;\n        this._completeAssets.length = 0;\n        this._completePaths.length = 0;\n    }\n\n    public startLoad(data: LoadData, loadProgress: (percent: number) => void, loadComplete: (error:Error, paths:string[], datas: any[]) => void, target: any = null): void {\n        this.startLoadList([data], loadProgress, loadComplete);\n    }\n\n    public startLoadList(dataList: LoadData[], loadProgress: (percent: number) => void, loadComplete: (error:Error, paths:string[], datas: any[]) => void, target: any = null): void {\n        if (this._isLoading) {\n            return;\n        }\n        this.clearData();\n        this._isLoading = true;\n        this._loadDataList = dataList;\n        this._progressCallback = loadProgress;\n        this._completeCallback = loadComplete;\n        this._target = target;\n        this._curIndex = 0;\n        this.loadNext();\n    }\n}\n"]}