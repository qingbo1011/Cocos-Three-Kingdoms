{"version":3,"sources":["file:///D:/git/github/mszlu/games/slg/ms-sg/assets/scripts/map/MapCommand.ts"],"names":["MapCommand","ServerConfig","ArmyCommand","GeneralCommand","NetManager","DateUtil","MapBuildProxy","MapCityProxy","MapProxy","MapUtil","MapUICommand","EventMgr","getInstance","_instance","destory","onDestory","constructor","on","role_myProperty","onRoleMyProperty","roleBuild_push","onRoleBuildStatePush","nationMap_config","onNationMapConfig","nationMap_scanBlock","onNationMapScanBlock","nationMap_giveUp","onNationMapGiveUp","nationMap_build","onNationMapBuild","nationMap_upBuild","onNationMapUpBuild","roleCity_push","onRoleCityPush","role_posTagList","onPosTagList","role_opPosTag","onOpPosTag","targetOff","initData","_proxy","_cityProxy","_buildProxy","clearData","_isQryMyProperty","proxy","cityProxy","buildProxy","data","console","log","code","updateMyProperty","msg","generals","armys","initMyCitys","citys","initMyBuilds","mr_builds","myId","getMyPlayerId","myUnionId","getMyMainCity","unionId","myParentId","parentId","posTagList","enterMap","updateBuild","setNationMapConfig","Confs","otherData","setMapScanBlock","id","updateMapPosTags","pos_tags","type","removeMapPosTag","x","y","emit","addMapPosTag","name","updateSub","rid","union_id","parent_id","updateCity","isBuildSub","buiildData","getBuild","isBuildWarFree","isWarFree","isCitySub","cityData","getCity","isCityWarFree","diff","getServerTime","occupyTime","getWarFree","isCanMoveCell","getIdByCellPoint","isCanOccupyCell","radius","getCellRadius","buildData","tx","ty","absX","Math","abs","absY","ok","hasResConfig","qryNationMapConfig","qryRoleMyProperty","sendData","send","qryRoleMyCity","role_myCity","qryNationMapScanBlock","qryData","startCellX","startCellY","length","len","giveUpBuild","build","upBuild","delBuild","nationMap_delBuild","upPosition","role_upPosition","opPosTag"],"mappings":"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","sourcesContent":["import { _decorator } from 'cc';\nimport { ServerConfig } from \"../config/ServerConfig\";\nimport ArmyCommand from \"../general/ArmyCommand\";\nimport GeneralCommand from \"../general/GeneralCommand\";\nimport { NetManager } from \"../network/socket/NetManager\";\nimport DateUtil from \"../utils/DateUtil\";\nimport MapBuildProxy, { MapBuildData } from \"./MapBuildProxy\";\nimport MapCityProxy, { MapCityData } from \"./MapCityProxy\";\nimport MapProxy, { MapAreaData } from \"./MapProxy\";\nimport MapUtil from \"./MapUtil\";\nimport MapUICommand from \"./ui/MapUICommand\";\nimport { EventMgr } from '../utils/EventMgr';\n\nexport default class MapCommand {\n    //单例\n    protected static _instance: MapCommand;\n    public static getInstance(): MapCommand {\n        if (this._instance == null) {\n            this._instance = new MapCommand();\n        }\n        return this._instance;\n    }\n\n    public static destory(): boolean {\n        if (this._instance) {\n            this._instance.onDestory();\n            this._instance = null;\n            return true;\n        }\n        return false;\n    }\n\n    //数据model\n    protected _proxy: MapProxy = new MapProxy();\n    protected _cityProxy: MapCityProxy = new MapCityProxy();\n    protected _buildProxy: MapBuildProxy = new MapBuildProxy();\n    protected _isQryMyProperty: boolean = false;\n\n    constructor() {\n        EventMgr.on(ServerConfig.role_myProperty, this.onRoleMyProperty, this);\n        EventMgr.on(ServerConfig.roleBuild_push, this.onRoleBuildStatePush, this);\n        EventMgr.on(ServerConfig.nationMap_config, this.onNationMapConfig, this);\n        EventMgr.on(ServerConfig.nationMap_scanBlock, this.onNationMapScanBlock, this);\n        EventMgr.on(ServerConfig.nationMap_giveUp, this.onNationMapGiveUp, this);\n        EventMgr.on(ServerConfig.nationMap_build, this.onNationMapBuild, this);\n        EventMgr.on(ServerConfig.nationMap_upBuild, this.onNationMapUpBuild, this);\n        EventMgr.on(ServerConfig.roleCity_push, this.onRoleCityPush, this);\n        EventMgr.on(ServerConfig.role_posTagList, this.onPosTagList, this);\n        EventMgr.on(ServerConfig.role_opPosTag, this.onOpPosTag, this);\n    }\n\n    public onDestory(): void {\n        EventMgr.targetOff(this);\n    }\n\n    public initData(): void {\n        this._proxy.initData();\n        this._cityProxy.initData();\n        this._buildProxy.initData();\n    }\n\n    public clearData(): void {\n        this._proxy.clearData();\n        this._cityProxy.clearData();\n        this._buildProxy.clearData();\n        this._isQryMyProperty = false;\n    }\n\n    public get proxy(): MapProxy {\n        return this._proxy;\n    }\n\n    public get cityProxy(): MapCityProxy {\n        return this._cityProxy;\n    }\n\n    public get buildProxy(): MapBuildProxy {\n        return this._buildProxy;\n    }\n\n    protected onRoleMyProperty(data: any): void {\n        console.log(\"onRoleMyProperty\", data);\n        if (data.code == 0) {\n            this._isQryMyProperty = true;\n            MapUICommand.getInstance().updateMyProperty(data);\n            GeneralCommand.getInstance().updateMyProperty(data.msg.generals);\n            ArmyCommand.getInstance().updateMyProperty(data.msg.armys);\n            this._cityProxy.initMyCitys(data.msg.citys);\n            this._buildProxy.initMyBuilds(data.msg.mr_builds);\n            this._cityProxy.myId = this._cityProxy.getMyPlayerId();\n            this._buildProxy.myId = this._cityProxy.getMyPlayerId();\n            this._cityProxy.myUnionId = this._cityProxy.getMyMainCity().unionId;\n            this._cityProxy.myParentId = this._cityProxy.getMyMainCity().parentId;\n            this._buildProxy.myUnionId = this._cityProxy.getMyMainCity().unionId;\n            this._buildProxy.myParentId = this._cityProxy.getMyMainCity().parentId;\n            MapCommand.getInstance().posTagList();\n            \n            this.enterMap();\n        }\n    }\n\n    protected onRoleBuildStatePush(data: any): void {\n        console.log(\"onRoleBuildStatePush\", data);\n        if (data.code == 0) {\n            this._buildProxy.updateBuild(data.msg);\n        }\n    }\n\n    protected onNationMapConfig(data: any): void {\n        console.log(\"onNationMapConfig\", data);\n        if (data.code == 0) {\n            this._proxy.setNationMapConfig(data.msg.Confs);\n            this.enterMap();\n        }\n    }\n\n    protected onNationMapScanBlock(data: any, otherData: any): void {\n        console.log(\"onNationMapScan\", data, otherData);\n        if (data.code == 0) {\n            this._cityProxy.setMapScanBlock(data.msg, otherData.id);\n            this._buildProxy.setMapScanBlock(data.msg, otherData.id);\n        }\n    }\n\n    protected onNationMapGiveUp(data: any, otherData: any): void {\n        console.log(\"onNationMapGiveUp\", data, otherData);\n    }\n\n    protected onNationMapBuild(data: any, otherData: any): void {\n        console.log(\"onNationMapBuild\", data, otherData);\n    }\n\n    protected onNationMapUpBuild(data: any, otherData: any): void {\n        console.log(\"onNationMapUpBuild\", data, otherData);\n    }\n\n    protected onPosTagList(data: any, otherData: any): void {\n        console.log(\"onPosTagList\", data, otherData);\n        if(data.code == 0){\n            this._proxy.updateMapPosTags(data.msg.pos_tags);\n        }\n    }\n\n    protected onOpPosTag(data: any, otherData: any): void {\n        console.log(\"onOpPosTag\", data, otherData);\n        if(data.code == 0){\n            if(data.msg.type == 0){\n                this._proxy.removeMapPosTag(data.msg.x, data.msg.y);\n                // EventMgr.emit(\"show_toast\", \"移除成功\");\n                EventMgr.emit(\"update_tag\");\n            }else if(data.msg.type == 1){\n                this._proxy.addMapPosTag(data.msg.x, data.msg.y, data.msg.name);\n                // EventMgr.emit(\"show_toast\", \"添加成功\");\n                EventMgr.emit(\"update_tag\");\n            }\n        }\n    }\n    \n\n    protected onRoleCityPush(data: any): void {\n        console.log(\"onRoleCityPush:\", data)\n        this._buildProxy.updateSub(data.msg.rid, data.msg.union_id, data.msg.parent_id);\n        this._cityProxy.updateCity(data.msg);\n        EventMgr.emit(\"unionChange\", data.msg.rid, data.msg.union_id, data.msg.parent_id);\n       \n    }\n\n    public isBuildSub(id: number): boolean {\n        let buiildData: MapBuildData = this.buildProxy.getBuild(id);\n        if (buiildData) {\n            if (buiildData.rid == this.buildProxy.myId){\n                return true;\n            }\n\n            if (buiildData.unionId > 0 && buiildData.unionId == this.buildProxy.myUnionId){\n                return true\n            }\n\n            if (buiildData.parentId > 0 && buiildData.parentId == this.buildProxy.myUnionId){\n                return true\n            }\n        }\n        return false\n    }\n\n    public isBuildWarFree(id: number): boolean {\n        let buiildData: MapBuildData = this.buildProxy.getBuild(id);\n        if(buiildData){\n            return buiildData.isWarFree();\n        }else{\n            return false;\n        }\n    }\n\n    \n    public isCitySub(id: number): boolean {\n        let cityData: MapCityData = this.cityProxy.getCity(id);\n        if (cityData) {\n            if (cityData.rid == this.cityProxy.myId){\n                return true\n            }\n\n            if (cityData.unionId > 0 && cityData.unionId == this.cityProxy.myUnionId){\n                return true\n            }\n\n            if (cityData.parentId > 0 && cityData.parentId == this.cityProxy.myUnionId){\n                return true\n            }\n        }\n        return false\n    }\n\n    public isCityWarFree(id: number): boolean {\n        let cityData: MapCityData = this.cityProxy.getCity(id);\n        if (cityData && cityData.parentId > 0) {\n            var diff = DateUtil.getServerTime() - cityData.occupyTime;\n            if(diff < MapCommand.getInstance().proxy.getWarFree()){\n                return true;\n            }\n        }\n        return false\n    }\n\n\n    /**是否是可行军的位置*/\n    public isCanMoveCell(x: number, y: number): boolean {\n        let id: number = MapUtil.getIdByCellPoint(x, y);\n        if (this.isBuildSub(id)){\n            return true\n        }\n\n        if (this.isCitySub(id)){\n            return true\n        }\n\n        return false\n    }\n\n    public isCanOccupyCell(x: number, y: number): boolean {\n        var radius = 0;\n        let id: number = MapUtil.getIdByCellPoint(x, y);\n        let cityData: MapCityData = this.cityProxy.getCity(id);\n        if (cityData) {\n            if(this.isCityWarFree(id)){\n                return false;\n            }\n            radius = cityData.getCellRadius();\n        }\n\n        let buildData: MapBuildData = this.buildProxy.getBuild(id);\n        if (buildData) {\n            if(this.isBuildWarFree(id)){\n                return false;\n            }\n\n            // console.log(\"buildData 11111:\", buildData);\n            radius = buildData.getCellRadius();\n        }\n\n        //查找半径10\n        for (let tx = x-10; tx <= x+10; tx++) {\n            for (let ty = y-10; ty <= y+10; ty++) {\n\n                let id: number = MapUtil.getIdByCellPoint(tx, ty);\n                let cityData: MapCityData = this.cityProxy.getCity(id);\n                if (cityData) {\n                    var absX = Math.abs(x-tx);\n                    var absY = Math.abs(y-ty);\n                    if (absX <= radius+cityData.getCellRadius()+1 && absY <= radius+cityData.getCellRadius()+1){\n                        var ok = this.isCitySub(id)\n                        if(ok){\n                            return true;\n                        }\n                    }\n                }\n        \n                let buildData: MapBuildData = this.buildProxy.getBuild(id);\n                if (buildData) {\n                    var absX = Math.abs(x-tx);\n                    var absY = Math.abs(y-ty);\n                    // console.log(\"MapBuildData:\", absX, absY, radius+buildData.getCellRadius()+1, buildData);\n                    if (absX <= radius+buildData.getCellRadius()+1 && absY <= radius+buildData.getCellRadius()+1){\n                        var ok = this.isBuildSub(id)\n                        if(ok){\n                            return true;\n                        }\n                    }\n                }\n            }\n        }\n        return false;\n    }\n\n    public enterMap(): void {\n        if (this._proxy.hasResConfig() == false) {\n            this.qryNationMapConfig();\n            return;\n        }\n        if (this._isQryMyProperty == false) {\n            this.qryRoleMyProperty();\n            return;\n        }\n        EventMgr.emit(\"enter_map\");\n    }\n\n    /**请求角色全量信息*/\n    public qryRoleMyProperty(): void {\n        let sendData: any = {\n            name: ServerConfig.role_myProperty,\n            msg: {\n            }\n        };\n        NetManager.getInstance().send(sendData);\n    }\n\n    /**请求自己的城池信息*/\n    public qryRoleMyCity(): void {\n        let sendData: any = {\n            name: ServerConfig.role_myCity,\n            msg: {}\n        };\n        NetManager.getInstance().send(sendData);\n    }\n\n    /**请求地图基础配置*/\n    public qryNationMapConfig(): void {\n        let sendData: any = {\n            name: ServerConfig.nationMap_config,\n            msg: {}\n        };\n        NetManager.getInstance().send(sendData);\n    }\n\n    public qryNationMapScanBlock(qryData: MapAreaData): void {\n        let sendData: any = {\n            name: ServerConfig.nationMap_scanBlock,\n            msg: {\n                x: qryData.startCellX,\n                y: qryData.startCellY,\n                length: qryData.len\n            }\n        };\n        NetManager.getInstance().send(sendData, qryData);\n    }\n\n    public giveUpBuild(x: number, y: number): void {\n        let sendData: any = {\n            name: ServerConfig.nationMap_giveUp,\n            msg: {\n                x: x,\n                y: y\n            }\n        };\n        NetManager.getInstance().send(sendData);\n    }\n\n    public build(x: number, y: number, type: number): void {\n        let sendData: any = {\n            name: ServerConfig.nationMap_build,\n            msg: {\n                x: x,\n                y: y,\n                type: type,\n            }\n        };\n        NetManager.getInstance().send(sendData);\n    }\n\n    public upBuild(x: number, y: number): void {\n        let sendData: any = {\n            name: ServerConfig.nationMap_upBuild,\n            msg: {\n                x: x,\n                y: y,\n            }\n        };\n        NetManager.getInstance().send(sendData);\n    }\n\n    public delBuild(x: number, y: number): void {\n        let sendData: any = {\n            name: ServerConfig.nationMap_delBuild,\n            msg: {\n                x: x,\n                y: y,\n            }\n        };\n        NetManager.getInstance().send(sendData);\n    }\n\n    \n    public upPosition(x: number, y: number): void {\n        let sendData: any = {\n            name: ServerConfig.role_upPosition,\n            msg: {\n                x: x,\n                y: y\n            }\n        };\n        NetManager.getInstance().send(sendData);\n    }\n\n    public posTagList(): void {\n        let sendData: any = {\n            name: ServerConfig.role_posTagList,\n            msg: {\n            }\n        };\n        NetManager.getInstance().send(sendData);\n    }\n\n    //1添加、0移除\n    public opPosTag(type:number, x: number, y: number, name = \"\"): void {\n        let sendData: any = {\n            name: ServerConfig.role_opPosTag,\n            msg: {\n                type:type,\n                x:x,\n                y:y,\n                name:name,\n            }\n        };\n        NetManager.getInstance().send(sendData);\n    }\n\n}\n"]}